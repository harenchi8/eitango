<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±å˜èªã‚«ãƒ¼ãƒ‰</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
        }

        .screen {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .active {
            display: block;
        }

        select,
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ddd;
            cursor: pointer;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        .card {
            text-align: center;
            padding: 40px;
            margin: 20px 0;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .question,
        .answer {
            font-size: 24px;
            margin: 20px 0;
        }

        .result-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .result-btn {
            font-size: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 10px;
        }

        .correct {
            background-color: #4CAF50;
        }

        .incorrect {
            background-color: #f44336;
        }

        .end-btn {
            background-color: #ff9800;
            margin-top: 20px;
        }

        .end-btn:hover {
            background-color: #f57c00;
        }

        .stats {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .celebration {
            font-size: 24px;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .question-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .perfect-score {
            font-size: 28px;
            color: #FFD700;
            text-align: center;
            margin: 20px 0;
            animation: celebrate 1s ease-in-out infinite;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .celebration-emoji {
            font-size: 36px;
            margin: 10px;
            display: inline-block;
            animation: bounce 1s ease infinite;
        }

        @keyframes celebrate {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-15px);
            }
        }

        .normal-complete {
            font-size: 24px;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .speaker-icon {
            cursor: pointer;
            font-size: 24px;
            color: #4a4a4a;
            background: none;
            border: none;
            padding: 10px;
            margin-left: 10px;
            transition: color 0.3s;
            vertical-align: middle;
        }

        .speaker-icon:hover {
            color: #2196F3;
        }

        .speaker-icon:active {
            transform: scale(0.95);
        }

        .word-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .speaking {
            animation: pulse 1s infinite;
            color: #2196F3;
        }

        /* Unité¸æŠç”¨ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
        .select-container {
            margin: 15px 0;
        }

        .select-container label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }

        select {
            width: 200px;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background-color: white;
            font-size: 16px;
        }

        select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 3px rgba(76, 175, 80, 0.3);
        }

        /* Unitãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ  */
        .checkbox-container {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
        }

        .checkbox-container h2 {
            font-size: 16px;
            margin: 0 0 10px 0;
            color: #333;
        }

        .unit-checkbox {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }

        .unit-checkbox input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .unit-checkbox label {
            cursor: pointer;
            user-select: none;
        }

        .select-all-container {
            padding-bottom: 10px;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        /* ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .validation-message {
            color: #f44336;
            font-size: 14px;
            margin: 5px 0;
            display: none;
        }

        /* é€²æ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .progress-indicator {
            text-align: center;
            margin: 10px 0;
            color: #666;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .progress-current {
            font-weight: bold;
            color: #4CAF50;
        }

        .progress-total {
            color: #666;
        }

        /* ã‚«ãƒ¼ãƒ‰å†…ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
        .card {
            position: relative;
            padding-top: 20px;
        }

        .word-container {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
    <div id="start-screen" class="screen active">
        <h1>è‹±å˜èªã‚«ãƒ¼ãƒ‰</h1>
        <div class="checkbox-container">
            <div class="select-all-container">
                <div class="unit-checkbox">
                    <input type="checkbox" id="select-all">
                    <label for="select-all">ã™ã¹ã¦é¸æŠ</label>
                </div>
            </div>
            <div id="unit-checkboxes">
                <!-- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
            </div>
        </div>
        <div class="validation-message" id="unit-validation-message">
            å°‘ãªãã¨ã‚‚1ã¤ã®Unitã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
        </div>
        <div class="select-container">
            <label for="question-type">å•é¡Œã‚¿ã‚¤ãƒ—:</label>
            <select id="question-type">
                <option value="word-to-meaning">å˜èªâ†’æ„å‘³</option>
                <option value="meaning-to-word">æ„å‘³â†’å˜èª</option>
            </select>
        </div>
        <button id="start-button">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>

    <!-- å•é¡Œç”»é¢ -->
    <div id="question-screen" class="screen">
        <div class="progress-indicator">
            Question <span id="question-progress-current" class="progress-current">1</span> /
            <span id="question-progress-total" class="progress-total">10</span>
        </div>
        <div class="card">
            <div class="word-container">
                <div class="question" id="question-text"></div>
                <button id="question-speaker" class="speaker-icon" title="èª­ã¿ä¸Šã’">ğŸ”Š</button>
            </div>
        </div>
        <div class="question-buttons">
            <button id="show-answer">ç­”ãˆã‚’è¦‹ã‚‹</button>
            <button id="end-button" class="end-btn">çµ‚äº†ã™ã‚‹</button>
        </div>
    </div>

    <!-- ç­”ãˆç”»é¢ -->
    <div id="answer-screen" class="screen">
        <div class="progress-indicator">
            Question <span id="answer-progress-current" class="progress-current">1</span> /
            <span id="answer-progress-total" class="progress-total">10</span>
        </div>
        <div class="card">
            <div class="word-container">
                <div class="answer" id="answer-text"></div>
                <button id="answer-speaker" class="speaker-icon" title="èª­ã¿ä¸Šã’">ğŸ”Š</button>
            </div>
        </div>
        <div class="button-container">
            <div>
                <button class="result-btn correct" id="correct-button">â­•</button>
                <button class="result-btn incorrect" id="incorrect-button">âŒ</button>
            </div>
            <button id="answer-end-button" class="end-btn">çµ‚äº†ã™ã‚‹</button>
        </div>
    </div>

    <!-- å®Œäº†ç”»é¢ -->
    <div id="complete-screen" class="screen">
        <!-- å…¨å•æ­£è§£æ™‚ã®è¡¨ç¤º -->
        <div id="perfect-message" style="display: none;">
            <div class="perfect-score">
                <div>ğŸ‰ å®Œç’§ãªæˆç¸¾ã§ã™ï¼ç´ æ™´ã‚‰ã—ã„ï¼ ğŸ‰</div>
                <div class="celebration-emoji">ğŸŒŸ</div>
                <div>å…¨å•æ­£è§£ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</div>
                <div class="celebration-emoji">ğŸ†</div>
                <div>ã‚ãªãŸã®è‹±èªåŠ›ã¯ç¢ºå®Ÿã«ä¸ŠãŒã£ã¦ã„ã¾ã™ï¼</div>
            </div>
        </div>

        <!-- é€šå¸¸ã®å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="normal-message" style="display: none;">
            <div class="normal-complete">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</div>
        </div>

        <div class="stats">
            <p>åˆè¨ˆå•é¡Œæ•°: <span id="total-questions">0</span></p>
            <p>æ­£è§£æ•°: <span id="correct-answers">0</span></p>
            <p>ä¸æ­£è§£æ•°: <span id="incorrect-answers">0</span></p>
        </div>

        <!-- é–“é•ãˆãŸå•é¡ŒãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤º -->
        <div id="retry-button-container" style="display: none;">
            <button id="retry-incorrect">é–“é•ãˆãŸå•é¡Œã‚’å¾©ç¿’ã™ã‚‹</button>
        </div>

        <button id="return-top">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</button>
    </div>


    <script>
        let vocabularyData = [];
        let currentQuestions = [];
        let currentIndex = 0;
        let incorrectQuestions = [];
        let stats = {
            correct: 0,
            incorrect: 0
        };

        // CSVãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        async function loadVocabularyData() {
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQOncZM-qRpnWgR0Bn9AFEJt654YAej9ydIQ-a3cv6HgAUDU_F2_y1T7EZw6CqJYPAKcxtk6nHJmY29/pub?gid=0&single=true&output=csv');
                const csvText = await response.text();

                // CSVã®è¡Œã‚’åˆ†å‰²
                const lines = csvText.split(/\r?\n/);

                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’é™¤å¤–ã—ã€å„è¡Œã‚’ãƒ‘ãƒ¼ã‚¹
                vocabularyData = lines.slice(1)
                    .filter(line => line.trim()) // ç©ºè¡Œã‚’é™¤å¤–
                    .map(line => {
                        const fields = parseCSVLine(line);
                        return {
                            word: fields[2],      // Cåˆ—ï¼šå˜èª
                            meaning: fields[1],   // Båˆ—ï¼šæ„å‘³
                            unit: fields[4]       // Eåˆ—ï¼šUnit
                        };
                    })
                    .filter(item => item.word && item.meaning); // ä¸å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ã‚’é™¤å¤–

                // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ­ã‚°å‡ºåŠ›
                // console.log('Loaded vocabulary data:', vocabularyData);

                // Unité¸æŠè‚¢ã‚’å‹•çš„ã«ç”Ÿæˆ
                updateUnitOptions();
            } catch (error) {
                // console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // CSVã®è¡Œã‚’é©åˆ‡ã«ãƒ‘ãƒ¼ã‚¹ã™ã‚‹é–¢æ•°ï¼ˆå¼•ç”¨ç¬¦å†…ã®ã‚«ãƒ³ãƒã‚’è€ƒæ…®ï¼‰
        function parseCSVLine(line) {
            const fields = [];
            let currentField = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸå¼•ç”¨ç¬¦
                        currentField += '"';
                        i++; // æ¬¡ã®å¼•ç”¨ç¬¦ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    } else {
                        // å¼•ç”¨ç¬¦ã®é–‹å§‹ã¾ãŸã¯çµ‚äº†
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åŒºåˆ‡ã‚Šï¼ˆå¼•ç”¨ç¬¦ã®å¤–å´ã®ã‚«ãƒ³ãƒï¼‰
                    fields.push(currentField.trim());
                    currentField = '';
                } else {
                    // é€šå¸¸ã®æ–‡å­—
                    currentField += char;
                }
            }

            // æœ€å¾Œã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
            fields.push(currentField.trim());

            return fields;
        }

        // ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        

        // é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // æ¬¡ã®å•é¡Œã«é€²ã‚€
        function goToNextQuestion() {
            currentIndex++;
            if (currentIndex < currentQuestions.length) {
                showQuestion();
            } else {
                // currentIndexã‚’èª¿æ•´ï¼ˆæœ€å¾Œã®å•é¡Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ï¼‰
                currentIndex--;
                showComplete();
            }
        }

        // é€²æ—è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ã‚’è¿½åŠ 
        function updateProgressIndicators() {
            const currentNumber = currentIndex + 1;
            const totalQuestions = currentQuestions.length;
            
            // å•é¡Œç”»é¢ã®é€²æ—ã‚’æ›´æ–°
            const questionCurrent = document.getElementById('question-progress-current');
            const questionTotal = document.getElementById('question-progress-total');
            if (questionCurrent && questionTotal) {
                questionCurrent.textContent = currentNumber;
                questionTotal.textContent = totalQuestions;
            }
            
            // ç­”ãˆç”»é¢ã®é€²æ—ã‚’æ›´æ–°
            const answerCurrent = document.getElementById('answer-progress-current');
            const answerTotal = document.getElementById('answer-progress-total');
            if (answerCurrent && answerTotal) {
                answerCurrent.textContent = currentNumber;
                answerTotal.textContent = totalQuestions;
            }
        }

        // Unité¸æŠè‚¢ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateUnitOptions() {
            const units = [...new Set(vocabularyData.map(item => item.unit))]
                .filter(unit => unit) // ç©ºå€¤ã‚’é™¤å¤–
                .sort((a, b) => Number(a) - Number(b)); // æ•°å€¤ã¨ã—ã¦æ˜‡é †ã‚½ãƒ¼ãƒˆ

            const unitCheckboxesContainer = document.getElementById('unit-checkboxes');
            unitCheckboxesContainer.innerHTML = ''; // æ—¢å­˜ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢

            units.forEach(unit => {
                const checkbox = document.createElement('div');
                checkbox.className = 'unit-checkbox';
                checkbox.innerHTML = `
                    <input type="checkbox" id="unit-${unit}" value="${unit}">
                    <label for="unit-${unit}">Unit ${unit}</label>
                `;
                unitCheckboxesContainer.appendChild(checkbox);
            });

            // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const selectAllCheckbox = document.getElementById('select-all');
            selectAllCheckbox.addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('#unit-checkboxes input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });

            // å€‹åˆ¥ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’ç›£è¦–
            const checkboxes = document.querySelectorAll('#unit-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    selectAllCheckbox.checked = allChecked;
                });
            });
        }

        // é¸æŠã•ã‚ŒãŸUnitã«åŸºã¥ã„ã¦å•é¡Œã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°ã‚’ä¿®æ­£
        function filterQuestionsBySelectedUnits() {
            const checkboxes = document.querySelectorAll('#unit-checkboxes input[type="checkbox"]:checked');
            const selectedUnits = Array.from(checkboxes).map(cb => cb.value);

            if (selectedUnits.length === 0) {
                return null; // é¸æŠãªã—ã®å ´åˆã¯nullã‚’è¿”ã™
            }

            return vocabularyData.filter(item => selectedUnits.includes(item.unit));
        }

        // å•é¡Œã‚’è¡¨ç¤ºã™ã‚‹
        function showQuestion() {
            const questionType = document.getElementById('question-type').value;
            const currentQuestion = currentQuestions[currentIndex];
            const questionText = questionType === 'word-to-meaning' ? 
                currentQuestion.word : currentQuestion.meaning;
            document.getElementById('question-text').textContent = questionText;
            
            // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
            const speakerIcon = document.getElementById('question-speaker');
            speakerIcon.style.display = questionType === 'word-to-meaning' ? 'inline-block' : 'none';
            
            // é€²æ—è¡¨ç¤ºã‚’æ›´æ–°
            updateProgressIndicators();
            
            showScreen('question-screen');
        }

        // ç­”ãˆã‚’è¡¨ç¤ºã™ã‚‹
        function showAnswer() {
            const questionType = document.getElementById('question-type').value;
            const currentQuestion = currentQuestions[currentIndex];
            const answerText = questionType === 'word-to-meaning' ? 
                currentQuestion.meaning : currentQuestion.word;
            document.getElementById('answer-text').textContent = answerText;
            
            // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
            const speakerIcon = document.getElementById('answer-speaker');
            speakerIcon.style.display = questionType === 'meaning-to-word' ? 'inline-block' : 'none';
            
            // é€²æ—è¡¨ç¤ºã‚’æ›´æ–°
            updateProgressIndicators();
            
            showScreen('answer-screen');
        }

        // éŸ³å£°èª­ã¿ä¸Šã’ç”¨ã®ã‚¯ãƒ©ã‚¹
        class SpeechHandler {
            constructor() {
                this.synthesis = window.speechSynthesis;
                this.voices = [];
                // éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
                this.loadVoices();
                // æ–°ã—ã„éŸ³å£°ãŒåˆ©ç”¨å¯èƒ½ã«ãªã£ãŸæ™‚ã®å‡¦ç†
                speechSynthesis.onvoiceschanged = () => {
                    this.loadVoices();
                };
            }

            // åˆ©ç”¨å¯èƒ½ãªéŸ³å£°ã‚’ãƒ­ãƒ¼ãƒ‰
            loadVoices() {
                this.voices = this.synthesis.getVoices();
                // è‹±èªã®éŸ³å£°ã‚’å„ªå…ˆçš„ã«é¸æŠ
                this.selectedVoice = this.voices.find(voice =>
                    voice.lang.startsWith('en-')
                ) || this.voices[0];
            }

            // ãƒ†ã‚­ã‚¹ãƒˆã‚’æ•´å½¢ã™ã‚‹é–¢æ•°ã‚’è¿½åŠ 
            cleanTextForSpeech(text) {
                return text
                    .replace(/~/g, '') // ãƒãƒ«ãƒ€ã‚’é™¤å»
                    .replace(/\s+/g, ' ') // è¤‡æ•°ã®ç©ºç™½ã‚’1ã¤ã«
                    .trim(); // å‰å¾Œã®ç©ºç™½ã‚’é™¤å»
            }

            // ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿ä¸Šã’
            speak(text, element) {
                // æ—¢å­˜ã®èª­ã¿ä¸Šã’ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                this.synthesis.cancel();

                // ãƒ†ã‚­ã‚¹ãƒˆã‚’æ•´å½¢
                const cleanedText = this.cleanTextForSpeech(text);

                // èª­ã¿ä¸Šã’ã‚‹å†…å®¹ã‚’è¨­å®š
                const utterance = new SpeechSynthesisUtterance(cleanedText);
                utterance.voice = this.selectedVoice;
                utterance.rate = 0.9;  // å°‘ã—ã‚†ã£ãã‚Š
                utterance.pitch = 1;
                utterance.volume = 1;

                // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ­ã‚°å‡ºåŠ›
                console.log('Reading text:', cleanedText);

                // èª­ã¿ä¸Šã’é–‹å§‹æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                element.classList.add('speaking');

                // èª­ã¿ä¸Šã’çµ‚äº†æ™‚ã®å‡¦ç†
                utterance.onend = () => {
                    element.classList.remove('speaking');
                };

                // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®å‡¦ç†
                utterance.onerror = (event) => {
                    console.error('Speech synthesis error:', event);
                    element.classList.remove('speaking');
                };

                // èª­ã¿ä¸Šã’é–‹å§‹
                this.synthesis.speak(utterance);
            }
        }

        // å®Œäº†ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
        function showComplete(excludeCurrentQuestion = false) {
            // å•é¡Œæ•°ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’ä¿®æ­£
            const questionsCount = excludeCurrentQuestion ?
                currentIndex : // ç¾åœ¨ã®å•é¡Œã‚’é™¤å¤–
                currentIndex + 1; // ç¾åœ¨ã®å•é¡Œã‚’å«ã‚€

            document.getElementById('total-questions').textContent = questionsCount;
            document.getElementById('correct-answers').textContent = stats.correct;
            document.getElementById('incorrect-answers').textContent = stats.incorrect;

            // å…¨å•æ­£è§£ã‹ã©ã†ã‹ã®ãƒã‚§ãƒƒã‚¯
            const perfectScore = stats.correct === questionsCount && stats.incorrect === 0 && questionsCount > 0;

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºåˆ¶å¾¡
            const perfectMessage = document.getElementById('perfect-message');
            const normalMessage = document.getElementById('normal-message');
            const retryButtonContainer = document.getElementById('retry-button-container');

            if (perfectScore) {
                perfectMessage.style.display = 'block';
                normalMessage.style.display = 'none';
            } else {
                perfectMessage.style.display = 'none';
                normalMessage.style.display = 'block';
            }

            // é–“é•ãˆãŸå•é¡ŒãŒã‚ã‚‹å ´åˆã®ã¿å¾©ç¿’ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            retryButtonContainer.style.display = incorrectQuestions.length > 0 ? 'block' : 'none';

            showScreen('complete-screen');
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        document.addEventListener('DOMContentLoaded', async () => {
            await loadVocabularyData();

            // éŸ³å£°èª­ã¿ä¸Šã’ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®åˆæœŸåŒ–
            const speechHandler = new SpeechHandler();

            // å•é¡Œç”»é¢ã®ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒœã‚¿ãƒ³
            document.getElementById('question-speaker').addEventListener('click', function () {
                const text = document.getElementById('question-text').textContent;
                speechHandler.speak(text, this);
            });

            // ç­”ãˆç”»é¢ã®ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒœã‚¿ãƒ³
            document.getElementById('answer-speaker').addEventListener('click', function () {
                const text = document.getElementById('answer-text').textContent;
                speechHandler.speak(text, this);
            });

            // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
            document.getElementById('start-button').addEventListener('click', () => {
                const filteredData = filterQuestionsBySelectedUnits();
            
                if (!filteredData) {
                    document.getElementById('unit-validation-message').style.display = 'block';
                    return;
                }

                if (filteredData.length === 0) {
                    alert('é¸æŠã—ãŸUnitã«ã¯å•é¡ŒãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                    return;
                }

                currentQuestions = shuffleArray([...filteredData]);
                currentIndex = 0;
                stats = { correct: 0, incorrect: 0 };
                incorrectQuestions = [];
                
                // é€²æ—è¡¨ç¤ºã‚’åˆæœŸåŒ–
                updateProgressIndicators();
                showQuestion();
            });

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´æ™‚ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éš ã™
            document.getElementById('unit-checkboxes').addEventListener('change', () => {
                document.getElementById('unit-validation-message').style.display = 'none';
            });

            // ç­”ãˆã‚’è¦‹ã‚‹ãƒœã‚¿ãƒ³
            document.getElementById('show-answer').addEventListener('click', showAnswer);

            // æ­£è§£ãƒœã‚¿ãƒ³
            document.getElementById('correct-button').addEventListener('click', function () {
                stats.correct++;
                goToNextQuestion();
            });

            // ä¸æ­£è§£ãƒœã‚¿ãƒ³
            document.getElementById('incorrect-button').addEventListener('click', function () {
                stats.incorrect++;
                incorrectQuestions.push(currentQuestions[currentIndex]);
                goToNextQuestion();
            });

            // Questionç”»é¢ã®çµ‚äº†ãƒœã‚¿ãƒ³
            document.getElementById('end-button').addEventListener('click', () => {
                showComplete(true); // ç¾åœ¨ã®å•é¡Œã‚’é™¤å¤–
            });

            // Answerç”»é¢ã®çµ‚äº†ãƒœã‚¿ãƒ³
            document.getElementById('answer-end-button').addEventListener('click', () => {
                showComplete(true); // ç¾åœ¨ã®å•é¡Œã‚’é™¤å¤–
            });

            // é–“é•ãˆãŸå•é¡Œã‚’å¾©ç¿’ã™ã‚‹ãƒœã‚¿ãƒ³
            document.getElementById('retry-incorrect').addEventListener('click', () => {
                if (incorrectQuestions.length > 0) {
                    currentQuestions = shuffleArray([...incorrectQuestions]);
                    currentIndex = 0;
                    stats = { correct: 0, incorrect: 0 };
                    incorrectQuestions = []; // å¾©ç¿’ç”¨ã®é…åˆ—ã‚’ã‚¯ãƒªã‚¢
                    showQuestion();
                }
            });

            // ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³
            document.getElementById('return-top').addEventListener('click', () => {
                showScreen('start-screen');
            });
        });
    </script>
</body>

</html>
