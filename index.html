<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëã±ÂçòË™û„Ç´„Éº„Éâ</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
        }

        .screen {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .active {
            display: block;
        }

        select,
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ddd;
            cursor: pointer;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        .card {
            text-align: center;
            padding: 40px;
            margin: 20px 0;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .question,
        .answer {
            font-size: 24px;
            margin: 20px 0;
        }

        .result-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .result-btn {
            font-size: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 10px;
        }

        .correct {
            background-color: #4CAF50;
        }

        .incorrect {
            background-color: #f44336;
        }

        .end-btn {
            background-color: #ff9800;
            margin-top: 20px;
        }

        .end-btn:hover {
            background-color: #f57c00;
        }

        .stats {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .celebration {
            font-size: 24px;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .question-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .perfect-score {
            font-size: 28px;
            color: #FFD700;
            text-align: center;
            margin: 20px 0;
            animation: celebrate 1s ease-in-out infinite;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .celebration-emoji {
            font-size: 36px;
            margin: 10px;
            display: inline-block;
            animation: bounce 1s ease infinite;
        }

        @keyframes celebrate {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-15px);
            }
        }

        .normal-complete {
            font-size: 24px;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .speaker-icon {
            cursor: pointer;
            font-size: 24px;
            color: #4a4a4a;
            background: none;
            border: none;
            padding: 10px;
            margin-left: 10px;
            transition: color 0.3s;
            vertical-align: middle;
        }

        .speaker-icon:hover {
            color: #2196F3;
        }

        .speaker-icon:active {
            transform: scale(0.95);
        }

        .word-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .speaking {
            animation: pulse 1s infinite;
            color: #2196F3;
        }

        /* UnitÈÅ∏ÊäûÁî®„ÅÆËøΩÂä†„Çπ„Çø„Ç§„É´ */
        .select-container {
            margin: 15px 0;
        }

        .select-container label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }

        select {
            width: 200px;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background-color: white;
            font-size: 16px;
        }

        select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 3px rgba(76, 175, 80, 0.3);
        }

        /* Unit„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÁî®„ÅÆ„Çπ„Çø„Ç§„É´ËøΩÂä† */
        .checkbox-container {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
        }

        .checkbox-container h2 {
            font-size: 16px;
            margin: 0 0 10px 0;
            color: #333;
        }

        .unit-checkbox {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }

        .unit-checkbox input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .unit-checkbox label {
            cursor: pointer;
            user-select: none;
        }

        .select-all-container {
            padding-bottom: 10px;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        /* „Éê„É™„Éá„Éº„Ç∑„Éß„É≥„É°„ÉÉ„Çª„Éº„Ç∏Áî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .validation-message {
            color: #f44336;
            font-size: 14px;
            margin: 5px 0;
            display: none;
        }

        /* ÈÄ≤Êçó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .progress-indicator {
            text-align: center;
            margin: 10px 0;
            color: #666;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .progress-current {
            font-weight: bold;
            color: #4CAF50;
        }

        .progress-total {
            color: #666;
        }

        /* „Ç´„Éº„ÉâÂÜÖ„ÅÆ„É¨„Ç§„Ç¢„Ç¶„ÉàË™øÊï¥ */
        .card {
            position: relative;
            padding-top: 20px;
        }

        .word-container {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <!-- „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
    <div id="start-screen" class="screen active">
        <h1>Ëã±ÂçòË™û„Ç´„Éº„Éâ</h1>
        <div class="checkbox-container">
            <div class="select-all-container">
                <div class="unit-checkbox">
                    <input type="checkbox" id="select-all">
                    <label for="select-all">„Åô„Åπ„Å¶ÈÅ∏Êäû</label>
                </div>
            </div>
            <div id="unit-checkboxes">
                <!-- „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅåÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
            </div>
        </div>
        <div class="validation-message" id="unit-validation-message">
            Â∞ë„Å™„Åè„Å®„ÇÇ1„Å§„ÅÆUnit„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        </div>
        <div class="select-container">
            <label for="question-type">ÂïèÈ°å„Çø„Ç§„Éó:</label>
            <select id="question-type">
                <option value="word-to-meaning">ÂçòË™û‚ÜíÊÑèÂë≥</option>
                <option value="meaning-to-word">ÊÑèÂë≥‚ÜíÂçòË™û</option>
            </select>
        </div>
        <button id="start-button">„Çπ„Çø„Éº„Éà</button>
    </div>

    <!-- ÂïèÈ°åÁîªÈù¢ -->
    <div id="question-screen" class="screen">
        <div class="progress-indicator">
            Question <span id="question-progress-current" class="progress-current">1</span> /
            <span id="question-progress-total" class="progress-total">10</span>
        </div>
        <div class="card">
            <div class="word-container">
                <div class="question" id="question-text"></div>
                <button id="question-speaker" class="speaker-icon" title="Ë™≠„Åø‰∏ä„Åí">üîä</button>
            </div>
        </div>
        <div class="question-buttons">
            <button id="show-answer">Á≠î„Åà„ÇíË¶ã„Çã</button>
            <button id="end-button" class="end-btn">ÁµÇ‰∫Ü„Åô„Çã</button>
        </div>
    </div>

    <!-- Á≠î„ÅàÁîªÈù¢ -->
    <div id="answer-screen" class="screen">
        <div class="progress-indicator">
            Question <span id="answer-progress-current" class="progress-current">1</span> /
            <span id="answer-progress-total" class="progress-total">10</span>
        </div>
        <div class="card">
            <div class="word-container">
                <div class="answer" id="answer-text"></div>
                <button id="answer-speaker" class="speaker-icon" title="Ë™≠„Åø‰∏ä„Åí">üîä</button>
            </div>
        </div>
        <div class="button-container">
            <div>
                <button class="result-btn correct" id="correct-button">‚≠ï</button>
                <button class="result-btn incorrect" id="incorrect-button">‚ùå</button>
            </div>
            <button id="answer-end-button" class="end-btn">ÁµÇ‰∫Ü„Åô„Çã</button>
        </div>
    </div>

    <!-- ÂÆå‰∫ÜÁîªÈù¢ -->
    <div id="complete-screen" class="screen">
        <!-- ÂÖ®ÂïèÊ≠£Ëß£ÊôÇ„ÅÆË°®Á§∫ -->
        <div id="perfect-message" style="display: none;">
            <div class="perfect-score">
                <div>üéâ ÂÆåÁíß„Å™ÊàêÁ∏æ„Åß„ÅôÔºÅÁ¥†Êô¥„Çâ„Åó„ÅÑÔºÅ üéâ</div>
                <div class="celebration-emoji">üåü</div>
                <div>ÂÖ®ÂïèÊ≠£Ëß£„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ</div>
                <div class="celebration-emoji">üèÜ</div>
                <div>„ÅÇ„Å™„Åü„ÅÆËã±Ë™ûÂäõ„ÅØÁ¢∫ÂÆü„Å´‰∏ä„Åå„Å£„Å¶„ÅÑ„Åæ„ÅôÔºÅ</div>
            </div>
        </div>

        <!-- ÈÄöÂ∏∏„ÅÆÂÆå‰∫Ü„É°„ÉÉ„Çª„Éº„Ç∏ -->
        <div id="normal-message" style="display: none;">
            <div class="normal-complete">„ÅäÁñ≤„ÇåÊßò„Åß„Åó„ÅüÔºÅ</div>
        </div>

        <div class="stats">
            <p>ÂêàË®àÂïèÈ°åÊï∞: <span id="total-questions">0</span></p>
            <p>Ê≠£Ëß£Êï∞: <span id="correct-answers">0</span></p>
            <p>‰∏çÊ≠£Ëß£Êï∞: <span id="incorrect-answers">0</span></p>
        </div>

        <!-- ÈñìÈÅï„Åà„ÅüÂïèÈ°å„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫ -->
        <div id="retry-button-container" style="display: none;">
            <button id="retry-incorrect">ÈñìÈÅï„Åà„ÅüÂïèÈ°å„ÇíÂæ©Áøí„Åô„Çã</button>
        </div>

        <button id="return-top">„Éà„ÉÉ„Éó„Å∏Êàª„Çã</button>
    </div>


    <script>
        let vocabularyData = [];
        let currentQuestions = [];
        let currentIndex = 0;
        let incorrectQuestions = [];
        let stats = {
            correct: 0,
            incorrect: 0
        };

        // CSV„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÇÄ
        async function loadVocabularyData() {
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQOncZM-qRpnWgR0Bn9AFEJt654YAej9ydIQ-a3cv6HgAUDU_F2_y1T7EZw6CqJYPAKcxtk6nHJmY29/pub?gid=0&single=true&output=csv');
                const csvText = await response.text();

                // CSV„ÅÆË°å„ÇíÂàÜÂâ≤
                const lines = csvText.split(/\r?\n/);

                // „Éò„ÉÉ„ÉÄ„ÉºË°å„ÇíÈô§Â§ñ„Åó„ÄÅÂêÑË°å„Çí„Éë„Éº„Çπ
                vocabularyData = lines.slice(1)
                    .filter(line => line.trim()) // Á©∫Ë°å„ÇíÈô§Â§ñ
                    .map(line => {
                        const fields = parseCSVLine(line);
                        return {
                            word: fields[2],      // CÂàóÔºöÂçòË™û
                            meaning: fields[1],   // BÂàóÔºöÊÑèÂë≥
                            unit: fields[4]       // EÂàóÔºöUnit
                        };
                    })
                    .filter(item => item.word && item.meaning); // ‰∏çÂÆåÂÖ®„Å™„Éá„Éº„Çø„ÇíÈô§Â§ñ

                // „Éá„Éê„ÉÉ„Ç∞Áî®„ÅÆ„É≠„Ç∞Âá∫Âäõ
                // console.log('Loaded vocabulary data:', vocabularyData);

                // UnitÈÅ∏ÊäûËÇ¢„ÇíÂãïÁöÑ„Å´ÁîüÊàê
                updateUnitOptions();
            } catch (error) {
                // console.error('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
                alert('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÊõ¥Êñ∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        // CSV„ÅÆË°å„ÇíÈÅ©Âàá„Å´„Éë„Éº„Çπ„Åô„ÇãÈñ¢Êï∞ÔºàÂºïÁî®Á¨¶ÂÜÖ„ÅÆ„Ç´„É≥„Éû„ÇíËÄÉÊÖÆÔºâ
        function parseCSVLine(line) {
            const fields = [];
            let currentField = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        // „Ç®„Çπ„Ç±„Éº„Éó„Åï„Çå„ÅüÂºïÁî®Á¨¶
                        currentField += '"';
                        i++; // Ê¨°„ÅÆÂºïÁî®Á¨¶„Çí„Çπ„Ç≠„ÉÉ„Éó
                    } else {
                        // ÂºïÁî®Á¨¶„ÅÆÈñãÂßã„Åæ„Åü„ÅØÁµÇ‰∫Ü
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // „Éï„Ç£„Éº„É´„Éâ„ÅÆÂå∫Âàá„ÇäÔºàÂºïÁî®Á¨¶„ÅÆÂ§ñÂÅ¥„ÅÆ„Ç´„É≥„ÉûÔºâ
                    fields.push(currentField.trim());
                    currentField = '';
                } else {
                    // ÈÄöÂ∏∏„ÅÆÊñáÂ≠ó
                    currentField += char;
                }
            }

            // ÊúÄÂæå„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÇíËøΩÂä†
            fields.push(currentField.trim());

            return fields;
        }

        // ÁîªÈù¢„ÇíÂàá„ÇäÊõø„Åà„Çã
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        

        // ÈÖçÂàó„Çí„Ç∑„É£„ÉÉ„Éï„É´„Åô„Çã
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Ê¨°„ÅÆÂïèÈ°å„Å´ÈÄ≤„ÇÄ
        function goToNextQuestion() {
            currentIndex++;
            if (currentIndex < currentQuestions.length) {
                showQuestion();
            } else {
                // currentIndex„ÇíË™øÊï¥ÔºàÊúÄÂæå„ÅÆÂïèÈ°å„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Å´Ôºâ
                currentIndex--;
                showComplete();
            }
        }

        // ÈÄ≤ÊçóË°®Á§∫„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞„ÇíËøΩÂä†
        function updateProgressIndicators() {
            const currentNumber = currentIndex + 1;
            const totalQuestions = currentQuestions.length;
            
            // ÂïèÈ°åÁîªÈù¢„ÅÆÈÄ≤Êçó„ÇíÊõ¥Êñ∞
            const questionCurrent = document.getElementById('question-progress-current');
            const questionTotal = document.getElementById('question-progress-total');
            if (questionCurrent && questionTotal) {
                questionCurrent.textContent = currentNumber;
                questionTotal.textContent = totalQuestions;
            }
            
            // Á≠î„ÅàÁîªÈù¢„ÅÆÈÄ≤Êçó„ÇíÊõ¥Êñ∞
            const answerCurrent = document.getElementById('answer-progress-current');
            const answerTotal = document.getElementById('answer-progress-total');
            if (answerCurrent && answerTotal) {
                answerCurrent.textContent = currentNumber;
                answerTotal.textContent = totalQuestions;
            }
        }

        // UnitÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
        function updateUnitOptions() {
            const units = [...new Set(vocabularyData.map(item => item.unit))]
                .filter(unit => unit) // Á©∫ÂÄ§„ÇíÈô§Â§ñ
                .sort((a, b) => Number(a) - Number(b)); // Êï∞ÂÄ§„Å®„Åó„Å¶ÊòáÈ†Ü„ÇΩ„Éº„Éà

            const unitCheckboxesContainer = document.getElementById('unit-checkboxes');
            unitCheckboxesContainer.innerHTML = ''; // Êó¢Â≠ò„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„ÇØ„É™„Ç¢

            units.forEach(unit => {
                const checkbox = document.createElement('div');
                checkbox.className = 'unit-checkbox';
                checkbox.innerHTML = `
                    <input type="checkbox" id="unit-${unit}" value="${unit}">
                    <label for="unit-${unit}">Unit ${unit}</label>
                `;
                unitCheckboxesContainer.appendChild(checkbox);
            });

            // ÂÖ®ÈÅ∏Êäû„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            const selectAllCheckbox = document.getElementById('select-all');
            selectAllCheckbox.addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('#unit-checkboxes input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });

            // ÂÄãÂà•„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
            const checkboxes = document.querySelectorAll('#unit-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    selectAllCheckbox.checked = allChecked;
                });
            });
        }

        // ÈÅ∏Êäû„Åï„Çå„ÅüUnit„Å´Âü∫„Å•„ÅÑ„Å¶ÂïèÈ°å„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Åô„ÇãÈñ¢Êï∞„Çí‰øÆÊ≠£
        function filterQuestionsBySelectedUnits() {
            const checkboxes = document.querySelectorAll('#unit-checkboxes input[type="checkbox"]:checked');
            const selectedUnits = Array.from(checkboxes).map(cb => cb.value);

            if (selectedUnits.length === 0) {
                return null; // ÈÅ∏Êäû„Å™„Åó„ÅÆÂ†¥Âêà„ÅØnull„ÇíËøî„Åô
            }

            return vocabularyData.filter(item => selectedUnits.includes(item.unit));
        }

        // ÂïèÈ°å„ÇíË°®Á§∫„Åô„Çã
        function showQuestion() {
            const questionType = document.getElementById('question-type').value;
            const currentQuestion = currentQuestions[currentIndex];
            const questionText = questionType === 'word-to-meaning' ? 
                currentQuestion.word : currentQuestion.meaning;
            document.getElementById('question-text').textContent = questionText;
            
            // „Çπ„Éî„Éº„Ç´„Éº„Ç¢„Ç§„Ç≥„É≥„ÅÆË°®Á§∫Âà∂Âæ°
            const speakerIcon = document.getElementById('question-speaker');
            speakerIcon.style.display = questionType === 'word-to-meaning' ? 'inline-block' : 'none';
            
            // ÈÄ≤ÊçóË°®Á§∫„ÇíÊõ¥Êñ∞
            updateProgressIndicators();
            
            showScreen('question-screen');
        }

        // Á≠î„Åà„ÇíË°®Á§∫„Åô„Çã
        function showAnswer() {
            const questionType = document.getElementById('question-type').value;
            const currentQuestion = currentQuestions[currentIndex];
            const answerText = questionType === 'word-to-meaning' ? 
                currentQuestion.meaning : currentQuestion.word;
            document.getElementById('answer-text').textContent = answerText;
            
            // „Çπ„Éî„Éº„Ç´„Éº„Ç¢„Ç§„Ç≥„É≥„ÅÆË°®Á§∫Âà∂Âæ°
            const speakerIcon = document.getElementById('answer-speaker');
            speakerIcon.style.display = questionType === 'meaning-to-word' ? 'inline-block' : 'none';
            
            // ÈÄ≤ÊçóË°®Á§∫„ÇíÊõ¥Êñ∞
            updateProgressIndicators();
            
            showScreen('answer-screen');
        }

        // Èü≥Â£∞Ë™≠„Åø‰∏ä„ÅíÁî®„ÅÆ„ÇØ„É©„Çπ
        class SpeechHandler {
            constructor() {
                this.synthesis = window.speechSynthesis;
                this.voices = [];
                // Èü≥Â£∞„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
                this.loadVoices();
                // Êñ∞„Åó„ÅÑÈü≥Â£∞„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Å£„ÅüÊôÇ„ÅÆÂá¶ÁêÜ
                speechSynthesis.onvoiceschanged = () => {
                    this.loadVoices();
                };
            }

            // Âà©Áî®ÂèØËÉΩ„Å™Èü≥Â£∞„Çí„É≠„Éº„Éâ
            loadVoices() {
                this.voices = this.synthesis.getVoices();
                // Ëã±Ë™û„ÅÆÈü≥Â£∞„ÇíÂÑ™ÂÖàÁöÑ„Å´ÈÅ∏Êäû
                this.selectedVoice = this.voices.find(voice =>
                    voice.lang.startsWith('en-')
                ) || this.voices[0];
            }

            // „ÉÜ„Ç≠„Çπ„Éà„ÇíÊï¥ÂΩ¢„Åô„ÇãÈñ¢Êï∞„ÇíËøΩÂä†
            cleanTextForSpeech(text) {
                return text
                    .replace(/~/g, '') // „ÉÅ„É´„ÉÄ„ÇíÈô§Âéª
                    .replace(/\s+/g, ' ') // Ë§áÊï∞„ÅÆÁ©∫ÁôΩ„Çí1„Å§„Å´
                    .trim(); // ÂâçÂæå„ÅÆÁ©∫ÁôΩ„ÇíÈô§Âéª
            }

            // „ÉÜ„Ç≠„Çπ„Éà„ÇíË™≠„Åø‰∏ä„Åí
            speak(text, element) {
                // Êó¢Â≠ò„ÅÆË™≠„Åø‰∏ä„Åí„Çí„Ç≠„É£„É≥„Çª„É´
                this.synthesis.cancel();

                // „ÉÜ„Ç≠„Çπ„Éà„ÇíÊï¥ÂΩ¢
                const cleanedText = this.cleanTextForSpeech(text);

                // Ë™≠„Åø‰∏ä„Åí„ÇãÂÜÖÂÆπ„ÇíË®≠ÂÆö
                const utterance = new SpeechSynthesisUtterance(cleanedText);
                utterance.voice = this.selectedVoice;
                utterance.rate = 0.9;  // Â∞ë„Åó„ÇÜ„Å£„Åè„Çä
                utterance.pitch = 1;
                utterance.volume = 1;

                // „Éá„Éê„ÉÉ„Ç∞Áî®„ÅÆ„É≠„Ç∞Âá∫Âäõ
                console.log('Reading text:', cleanedText);

                // Ë™≠„Åø‰∏ä„ÅíÈñãÂßãÊôÇ„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                element.classList.add('speaking');

                // Ë™≠„Åø‰∏ä„ÅíÁµÇ‰∫ÜÊôÇ„ÅÆÂá¶ÁêÜ
                utterance.onend = () => {
                    element.classList.remove('speaking');
                };

                // „Ç®„É©„ÉºÁô∫ÁîüÊôÇ„ÅÆÂá¶ÁêÜ
                utterance.onerror = (event) => {
                    console.error('Speech synthesis error:', event);
                    element.classList.remove('speaking');
                };

                // Ë™≠„Åø‰∏ä„ÅíÈñãÂßã
                this.synthesis.speak(utterance);
            }
        }

        // ÂÆå‰∫ÜÁîªÈù¢„ÇíË°®Á§∫„Åô„Çã
        function showComplete(excludeCurrentQuestion = false) {
            // ÂïèÈ°åÊï∞„ÅÆ„Ç´„Ç¶„É≥„Éà„Çí‰øÆÊ≠£
            const questionsCount = excludeCurrentQuestion ?
                currentIndex : // ÁèæÂú®„ÅÆÂïèÈ°å„ÇíÈô§Â§ñ
                currentIndex + 1; // ÁèæÂú®„ÅÆÂïèÈ°å„ÇíÂê´„ÇÄ

            document.getElementById('total-questions').textContent = questionsCount;
            document.getElementById('correct-answers').textContent = stats.correct;
            document.getElementById('incorrect-answers').textContent = stats.incorrect;

            // ÂÖ®ÂïèÊ≠£Ëß£„Åã„Å©„ÅÜ„Åã„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
            const perfectScore = stats.correct === questionsCount && stats.incorrect === 0 && questionsCount > 0;

            // „É°„ÉÉ„Çª„Éº„Ç∏„ÅÆË°®Á§∫Âà∂Âæ°
            const perfectMessage = document.getElementById('perfect-message');
            const normalMessage = document.getElementById('normal-message');
            const retryButtonContainer = document.getElementById('retry-button-container');

            if (perfectScore) {
                perfectMessage.style.display = 'block';
                normalMessage.style.display = 'none';
            } else {
                perfectMessage.style.display = 'none';
                normalMessage.style.display = 'block';
            }

            // ÈñìÈÅï„Åà„ÅüÂïèÈ°å„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÂæ©Áøí„Éú„Çø„É≥„ÇíË°®Á§∫
            retryButtonContainer.style.display = incorrectQuestions.length > 0 ? 'block' : 'none';

            showScreen('complete-screen');
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
        document.addEventListener('DOMContentLoaded', async () => {
            await loadVocabularyData();

            // Èü≥Â£∞Ë™≠„Åø‰∏ä„Åí„Éè„É≥„Éâ„É©„Éº„ÅÆÂàùÊúüÂåñ
            const speechHandler = new SpeechHandler();

            // ÂïèÈ°åÁîªÈù¢„ÅÆ„Çπ„Éî„Éº„Ç´„Éº„Éú„Çø„É≥
            document.getElementById('question-speaker').addEventListener('click', function () {
                const text = document.getElementById('question-text').textContent;
                speechHandler.speak(text, this);
            });

            // Á≠î„ÅàÁîªÈù¢„ÅÆ„Çπ„Éî„Éº„Ç´„Éº„Éú„Çø„É≥
            document.getElementById('answer-speaker').addEventListener('click', function () {
                const text = document.getElementById('answer-text').textContent;
                speechHandler.speak(text, this);
            });

            // „Çπ„Çø„Éº„Éà„Éú„Çø„É≥
            document.getElementById('start-button').addEventListener('click', () => {
                const filteredData = filterQuestionsBySelectedUnits();
            
                if (!filteredData) {
                    document.getElementById('unit-validation-message').style.display = 'block';
                    return;
                }

                if (filteredData.length === 0) {
                    alert('ÈÅ∏Êäû„Åó„ÅüUnit„Å´„ÅØÂïèÈ°å„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                    return;
                }

                currentQuestions = shuffleArray([...filteredData]);
                currentIndex = 0;
                stats = { correct: 0, incorrect: 0 };
                incorrectQuestions = [];
                
                // ÈÄ≤ÊçóË°®Á§∫„ÇíÂàùÊúüÂåñ
                updateProgressIndicators();
                showQuestion();
            });

            // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂ§âÊõ¥ÊôÇ„Å´„Éê„É™„Éá„Éº„Ç∑„Éß„É≥„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈö†„Åô
            document.getElementById('unit-checkboxes').addEventListener('change', () => {
                document.getElementById('unit-validation-message').style.display = 'none';
            });

            // Á≠î„Åà„ÇíË¶ã„Çã„Éú„Çø„É≥
            document.getElementById('show-answer').addEventListener('click', showAnswer);

            // Ê≠£Ëß£„Éú„Çø„É≥
            document.getElementById('correct-button').addEventListener('click', function () {
                stats.correct++;
                goToNextQuestion();
            });

            // ‰∏çÊ≠£Ëß£„Éú„Çø„É≥
            document.getElementById('incorrect-button').addEventListener('click', function () {
                stats.incorrect++;
                incorrectQuestions.push(currentQuestions[currentIndex]);
                goToNextQuestion();
            });

            // QuestionÁîªÈù¢„ÅÆÁµÇ‰∫Ü„Éú„Çø„É≥
            document.getElementById('end-button').addEventListener('click', () => {
                showComplete(true); // ÁèæÂú®„ÅÆÂïèÈ°å„ÇíÈô§Â§ñ
            });

            // AnswerÁîªÈù¢„ÅÆÁµÇ‰∫Ü„Éú„Çø„É≥
            document.getElementById('answer-end-button').addEventListener('click', () => {
                showComplete(true); // ÁèæÂú®„ÅÆÂïèÈ°å„ÇíÈô§Â§ñ
            });

            // ÈñìÈÅï„Åà„ÅüÂïèÈ°å„ÇíÂæ©Áøí„Åô„Çã„Éú„Çø„É≥
            document.getElementById('retry-incorrect').addEventListener('click', () => {
                if (incorrectQuestions.length > 0) {
                    currentQuestions = shuffleArray([...incorrectQuestions]);
                    currentIndex = 0;
                    stats = { correct: 0, incorrect: 0 };
                    incorrectQuestions = []; // Âæ©ÁøíÁî®„ÅÆÈÖçÂàó„Çí„ÇØ„É™„Ç¢
                    showQuestion();
                }
            });

            // „Éà„ÉÉ„Éó„Å∏Êàª„Çã„Éú„Çø„É≥
            document.getElementById('return-top').addEventListener('click', () => {
                showScreen('start-screen');
            });
        });
    </script>
</body>

</html>
